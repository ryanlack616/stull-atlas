import{M as A,r as s,F as b,E as p,P as y,a as R}from"./index-Djbrw6no.js";function U(l,c){var F,M;const o=[],n=[],m=[];o.push({operation:"begin",inputs:{recipe:l.name},output:0,note:`Starting UMF calculation for "${l.name}"`});const x=[];for(const e of l.ingredients){const t=c.resolve(e.material);if(!t){m.push(`Unknown material: ${e.material}`),o.push({operation:"material_resolution",inputs:{name:e.material},output:0,note:`FAILED: Could not resolve "${e.material}"`});continue}const i=c.getAnalysis(t.id);if(!i){n.push(`No analysis for "${e.material}"`),o.push({operation:"material_resolution",inputs:{name:e.material,materialId:t.id},output:0,note:`WARNING: No oxide analysis available for "${t.primaryName}"`});continue}x.push({ingredient:e,material:t,analysis:i}),t.discontinued&&n.push(`"${t.primaryName}" is discontinued — analysis data may not match current substitutes`),t.primaryName.toLowerCase()!==e.material.toLowerCase().trim()&&!t.aliases.some(h=>h.toLowerCase()===e.material.toLowerCase().trim())&&n.push(`"${e.material}" resolved to "${t.primaryName}" via fuzzy match — verify this is correct`),o.push({operation:"material_resolution",inputs:{name:e.material},output:1,note:`Resolved "${e.material}" → ${t.primaryName}${t.discontinued?" (DISCONTINUED)":""}`})}if(m.length>0)return{value:null,confidence:"unknown",warnings:n,errors:m,trace:o};if(x.length===0)return m.push("No materials could be resolved"),{value:null,confidence:"unknown",warnings:n,errors:m,trace:o};const O={};for(const{ingredient:e,material:t,analysis:i}of x)for(const[h,_]of Object.entries(i)){if(_===0)continue;const g=h,S=A[g];if(!S){n.push(`Unknown molecular weight for ${h}`);continue}const N=e.amount*(_/100)/S;O[g]=(O[g]||0)+N,o.push({operation:"oxide_contribution",inputs:{material:t.primaryName,amount:e.amount,oxide:g,weightPercent:_,molecularWeight:S},output:N,note:`${e.amount}g ${t.primaryName} × ${_}% ${h} ÷ ${S} = ${s(N,4)} mol`})}let d=0;for(const e of b)d+=O[e]||0;if(o.push({operation:"flux_sum",inputs:Object.fromEntries(b.map(e=>[e,O[e]||0])),output:d,note:`Total flux moles: ${s(d,4)}`}),d<p)return m.push("No flux oxides found - cannot calculate UMF (division by zero)"),{value:null,confidence:"unknown",warnings:n,errors:m,trace:o};const r={};for(const[e,t]of Object.entries(O)){if(t===void 0||t===0)continue;const i=t/d,h=e;r[h]={value:s(i,y.moles),precision:y.umfOxide,state:"inferred",source:"calculated from recipe"},o.push({operation:"normalize",inputs:{oxide:e,moles:t,fluxMoles:d},output:i,note:`${e}: ${s(t,4)} ÷ ${s(d,4)} = ${s(i,4)}`})}const u=((F=r.SiO2)==null?void 0:F.value)||0,a=((M=r.Al2O3)==null?void 0:M.value)||0,f=R.R2O.reduce((e,t)=>{var i;return e+(((i=r[t])==null?void 0:i.value)||0)},0),w=R.RO.reduce((e,t)=>{var i;return e+(((i=r[t])==null?void 0:i.value)||0)},0);r._meta={SiO2_Al2O3_ratio:a>p?s(u/a,2):0,R2O_RO_ratio:w>p?s(f/w,2):0,totalFluxMoles:d,confidence:n.length>0?"assumed":"inferred"},o.push({operation:"derived_values",inputs:{SiO2:u,Al2O3:a,R2O:f,RO:w},output:r._meta,note:`SiO2:Al2O3 = ${r._meta.SiO2_Al2O3_ratio}, R2O:RO = ${r._meta.R2O_RO_ratio}`});const $=b.reduce((e,t)=>{var i;return e+(((i=r[t])==null?void 0:i.value)||0)},0);return Math.abs($-1)>p&&n.push(`Flux sum ${s($,4)} != 1.0 (rounding error)`),o.push({operation:"verify",inputs:{expectedFluxSum:1,actualFluxSum:$},output:Math.abs($-1)<p?1:0,note:`Verification: flux sum = ${s($,4)}`}),{value:r,confidence:n.length>0?"assumed":"inferred",warnings:n,errors:m,trace:o}}function E(l,c,o){return{value:s(l,y.moles),precision:y.umfOxide,state:c,source:o}}function v(l,c){var o;return((o=l[c])==null?void 0:o.value)||0}function C(l,c){if(l.length!==c.length)throw new Error("UMF count must match weight count");const o=c.reduce((u,a)=>u+a,0);if(Math.abs(o-1)>p)throw new Error(`Weights must sum to 1.0, got ${o}`);const n={},m=new Set;for(const u of l)for(const a of Object.keys(u))a!=="_meta"&&m.add(a);for(const u of m){let a=0;for(let f=0;f<l.length;f++)a+=v(l[f],u)*c[f];a>p&&(n[u]=E(a,"inferred",`interpolated weights=[${c.map(f=>s(f,2)).join(",")}]`))}const x=v(n,"SiO2"),O=v(n,"Al2O3"),d=R.R2O.reduce((u,a)=>u+v(n,a),0),r=R.RO.reduce((u,a)=>u+v(n,a),0);return n._meta={SiO2_Al2O3_ratio:O>p?s(x/O,2):0,R2O_RO_ratio:r>p?s(d/r,2):0,totalFluxMoles:0,confidence:"inferred"},n}export{E as c,v as g,C as i,U as r};
