import{r as C,j as s}from"./vendor-react-D380Hx73.js";import{r as N,b as I,j as D}from"./index-Beyst0Xe.js";import"./vendor-state-CUnBHQ16.js";import"./vendor-router-1trnvaIQ.js";function E(m,l={epsilon:.15,minPoints:5}){const{epsilon:x,minPoints:b}=l,o=m.filter(n=>n.x!=null&&n.y!=null&&!isNaN(n.x)&&!isNaN(n.y)),u=o.length,p=new Array(u).fill(-1);let f=0;function g(n){const a=[],d=o[n];for(let t=0;t<u;t++){if(t===n)continue;const i=o[t];Math.sqrt(Math.pow(d.x-i.x,2)+Math.pow(d.y-i.y,2))<=x&&a.push(t)}return a}function j(n,a,d){p[n]=d;const t=[...a];for(;t.length>0;){const i=t.shift();if(p[i]===-1){p[i]=d;const h=g(i);if(h.length>=b)for(const S of h)(p[S]===-1||p[S]===0)&&t.push(S)}else p[i]===0&&(p[i]=d)}}for(let n=0;n<u;n++){if(p[n]!==-1)continue;const a=g(n);a.length<b?p[n]=0:(f++,j(n,a,f))}const y=new Map,c=[];for(let n=0;n<u;n++){const a=p[n];a===0?c.push(o[n].id):(y.has(a)||y.set(a,[]),y.get(a).push(o[n]))}const v=[];for(const[n,a]of y){const d=V(n,a);v.push(d)}return v.sort((n,a)=>a.stats.count-n.stats.count),{clusters:v,noise:c,stats:{totalPoints:u,clusteredPoints:u-c.length,noisePoints:c.length,clusterCount:v.length}}}function V(m,l){var a,d;const x=l.map(t=>t.x),b=l.map(t=>t.y),o={x:N(x.reduce((t,i)=>t+i,0)/l.length,3),y:N(b.reduce((t,i)=>t+i,0)/l.length,3)},u={xMin:Math.min(...x),xMax:Math.max(...x),yMin:Math.min(...b),yMax:Math.max(...b)},f=l.map(t=>Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2))).reduce((t,i)=>t+i,0)/l.length,g=l.filter(t=>t.cone!=null).map(t=>t.cone),j=g.length>0?N(g.reduce((t,i)=>t+i,0)/g.length,1):null,y=new Map,c=new Map;for(const t of l)y.set(t.surfaceType,(y.get(t.surfaceType)||0)+1),c.set(t.source,(c.get(t.source)||0)+1);const v=((a=[...y.entries()].sort((t,i)=>i[1]-t[1])[0])==null?void 0:a[0])||"unknown",n=((d=[...c.entries()].sort((t,i)=>i[1]-t[1])[0])==null?void 0:d[0])||"unknown";return{id:m,pointIds:l.map(t=>t.id),centroid:o,bounds:u,stats:{count:l.length,avgCone:j,dominantSurface:v,dominantSource:n,cohesion:N(f,4)}}}function G(m,l){return Math.exp(-(m*m)/(2*l*l))}function q(m,l={}){const{resolution:x=100,bandwidth:b=.1,padding:o=.1}=l,u=m.filter(t=>t.x!=null&&t.y!=null&&!isNaN(t.x)&&!isNaN(t.y)&&t.x>0&&t.y>0);if(u.length===0)return{grid:[],bounds:{xMin:0,xMax:1,yMin:0,yMax:1},resolution:x,maxDensity:0,totalPoints:0};const p=u.map(t=>t.x),f=u.map(t=>t.y),g=Math.max(...p)-Math.min(...p),j=Math.max(...f)-Math.min(...f),y={xMin:Math.min(...p)-g*o,xMax:Math.max(...p)+g*o,yMin:Math.min(...f)-j*o,yMax:Math.max(...f)+j*o},c=Array(x).fill(null).map(()=>Array(x).fill(0)),v=(y.xMax-y.xMin)/x,n=(y.yMax-y.yMin)/x,a=Math.ceil(b*3/Math.min(v,n));for(const t of u){const i=Math.floor((t.x-y.xMin)/v),h=Math.floor((t.y-y.yMin)/n);for(let S=-a;S<=a;S++)for(let r=-a;r<=a;r++){const w=i+S,M=h+r;if(w>=0&&w<x&&M>=0&&M<x){const k=y.xMin+(w+.5)*v,e=y.yMin+(M+.5)*n,z=Math.sqrt(Math.pow(k-t.x,2)+Math.pow(e-t.y,2)),T=G(z,b);c[M][w]+=T}}}let d=0;for(const t of c)for(const i of t)d=Math.max(d,i);return{grid:c,bounds:y,resolution:x,maxDensity:d,totalPoints:u.length}}function X(m,l={}){const{densityThreshold:x=.1,minVoidSize:b=10,maxVoids:o=20}=l,u=q(m,{resolution:80}),{grid:p,bounds:f,resolution:g,maxDensity:j}=u;if(j===0)return[];const y=(f.xMax-f.xMin)/g,c=(f.yMax-f.yMin)/g,v=j*x,n=Array(g).fill(null).map(()=>Array(g).fill(!1)),a=[];let d=0;for(let t=0;t<g;t++)for(let i=0;i<g;i++){if(n[t][i])continue;if(p[t][i]>=v){n[t][i]=!0;continue}const h=[],S=[{x:i,y:t}];for(;S.length>0;){const r=S.shift();if(n[r.y][r.x]||p[r.y][r.x]>=v)continue;n[r.y][r.x]=!0,h.push(r);const w=[{x:r.x+1,y:r.y},{x:r.x-1,y:r.y},{x:r.x,y:r.y+1},{x:r.x,y:r.y-1}];for(const M of w)M.x>=0&&M.x<g&&M.y>=0&&M.y<g&&(n[M.y][M.x]||S.push(M))}if(h.length>=b){const r={x:h.reduce((T,F)=>T+F.x,0)/h.length,y:h.reduce((T,F)=>T+F.y,0)/h.length},w={x:N(f.xMin+r.x*y,3),y:N(f.yMin+r.y*c,3)},M=h.length*y*c,k=N(Math.sqrt(M/Math.PI),3),e=Y(m,w,5);let z="low";h.length>b*5?z="high":h.length>b*2&&(z="medium"),a.push({id:`void_${d++}`,center:w,radius:k,area:N(M,4),nearestGlazes:e,significance:z})}}return a.sort((t,i)=>i.area-t.area).slice(0,o)}function Y(m,l,x){return m.filter(o=>o.x!=null&&o.y!=null).map(o=>({id:o.id,distance:Math.sqrt(Math.pow(o.x-l.x,2)+Math.pow(o.y-l.y,2))})).sort((o,u)=>o.distance-u.distance).slice(0,x).map(o=>o.id)}function _({onHighlightCluster:m,onHighlightVoid:l,onDensityMap:x}){const{getPlotPoints:b}=I(),o=D(e=>e.currentSetId),[u,p]=C.useState(.15),[f,g]=C.useState(5),[j,y]=C.useState(null),[c,v]=C.useState(null),[n,a]=C.useState([]),[d,t]=C.useState("clusters"),[i,h]=C.useState(!1),S=C.useMemo(()=>b(o),[b,o]),r=C.useMemo(()=>S.filter(e=>e.x>0&&e.y>0&&!isNaN(e.x)&&!isNaN(e.y)),[S]),w=C.useCallback(()=>{h(!0),setTimeout(()=>{const e=E(r,{epsilon:u,minPoints:f});y(e),h(!1)},10)},[r,u,f]),M=C.useCallback(()=>{h(!0),setTimeout(()=>{const e=q(r,{resolution:80,bandwidth:.1});v(e),x==null||x(e),h(!1)},10)},[r,x]),k=C.useCallback(()=>{h(!0),setTimeout(()=>{const e=X(r,{densityThreshold:.1,minVoidSize:10});a(e),h(!1)},10)},[r]);return s.jsxs("div",{className:"analysis-panel",children:[s.jsx("h3",{style:{margin:"0 0 12px",fontSize:14},children:"Analysis"}),s.jsxs("p",{style:{margin:"0 0 16px",fontSize:12,color:"var(--text-secondary)"},children:[r.length.toLocaleString()," points loaded"]}),s.jsx("div",{style:{display:"flex",gap:2,marginBottom:16},role:"tablist","aria-label":"Analysis tools",children:["clusters","density","voids"].map(e=>s.jsx("button",{onClick:()=>t(e),role:"tab","aria-selected":d===e,style:{flex:1,padding:"6px 8px",background:d===e?"var(--accent-bg)":"var(--bg-input)",border:`1px solid ${d===e?"var(--accent)":"var(--border-secondary)"}`,borderRadius:4,color:d===e?"var(--text-bright)":"var(--text-secondary)",fontSize:11,cursor:"pointer",textTransform:"capitalize"},children:e},e))}),d==="clusters"&&s.jsxs("div",{children:[s.jsxs("div",{style:{marginBottom:12},children:[s.jsxs("label",{style:A,children:["Epsilon (neighborhood size)",s.jsx("input",{type:"range",min:.05,max:.5,step:.01,value:u,onChange:e=>p(Number(e.target.value)),style:{width:"100%"}}),s.jsx("span",{style:B,children:u.toFixed(2)})]}),s.jsxs("label",{style:A,children:["Min points per cluster",s.jsx("input",{type:"range",min:3,max:20,step:1,value:f,onChange:e=>g(Number(e.target.value)),style:{width:"100%"}}),s.jsx("span",{style:B,children:f})]})]}),s.jsx("button",{onClick:w,disabled:i,style:R,children:i?"Computing...":"Run DBSCAN"}),j&&s.jsxs("div",{style:{marginTop:12},children:[s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Clusters found"}),s.jsx("strong",{children:j.stats.clusterCount})]}),s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Clustered points"}),s.jsx("strong",{children:j.stats.clusteredPoints})]}),s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Noise points"}),s.jsx("strong",{children:j.stats.noisePoints})]}),s.jsx("div",{style:{marginTop:12},children:j.clusters.map(e=>s.jsxs("div",{onClick:()=>m==null?void 0:m(e.pointIds),style:{padding:"8px 10px",marginBottom:4,background:"var(--bg-tertiary)",border:"1px solid var(--border-primary)",borderRadius:4,cursor:"pointer",fontSize:12},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[s.jsxs("span",{style:{color:"var(--text-bright)"},children:["Cluster ",e.id]}),s.jsxs("span",{style:{color:"var(--text-secondary)"},children:[e.stats.count," pts"]})]}),s.jsxs("div",{style:{color:"var(--text-muted)",marginTop:2},children:["center: (",e.centroid.x.toFixed(2),", ",e.centroid.y.toFixed(2),") · ",e.stats.dominantSurface]})]},e.id))})]})]}),d==="density"&&s.jsxs("div",{children:[s.jsx("button",{onClick:M,disabled:i,style:R,children:i?"Computing...":"Calculate Density"}),c&&s.jsxs("div",{style:{marginTop:12},children:[s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Resolution"}),s.jsxs("strong",{children:[c.resolution,"×",c.resolution]})]}),s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Max density"}),s.jsx("strong",{children:c.maxDensity.toFixed(1)})]}),s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Total points"}),s.jsx("strong",{children:c.totalPoints})]}),s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Bounds"}),s.jsxs("strong",{style:{fontSize:10},children:["x:[",c.bounds.xMin.toFixed(1),", ",c.bounds.xMax.toFixed(1),"] y:[",c.bounds.yMin.toFixed(1),", ",c.bounds.yMax.toFixed(1),"]"]})]})]})]}),d==="voids"&&s.jsxs("div",{children:[s.jsx("button",{onClick:k,disabled:i,style:R,children:i?"Computing...":"Find Voids"}),n.length>0&&s.jsxs("div",{style:{marginTop:12},children:[s.jsxs("div",{style:P,children:[s.jsx("span",{children:"Voids found"}),s.jsx("strong",{children:n.length})]}),n.map(e=>s.jsxs("div",{onClick:()=>l==null?void 0:l(e.center,e.radius),style:{padding:"8px 10px",marginBottom:4,background:"var(--bg-tertiary)",border:"1px solid var(--border-primary)",borderRadius:4,cursor:"pointer",fontSize:12},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[s.jsxs("span",{style:{color:"var(--text-bright)"},children:["(",e.center.x.toFixed(2),", ",e.center.y.toFixed(2),")"]}),s.jsx("span",{style:{color:e.significance==="high"?"#e74c3c":e.significance==="medium"?"#e67e22":"var(--text-secondary)"},children:e.significance})]}),s.jsxs("div",{style:{color:"var(--text-muted)",marginTop:2},children:["radius: ",e.radius.toFixed(2)," · area: ",e.area.toFixed(2)]})]},e.id))]})]}),s.jsx("style",{children:`
        .analysis-panel {
          padding: 0;
        }
      `})]})}const A={display:"block",fontSize:11,color:"var(--text-secondary)",marginBottom:8},B={float:"right",fontFamily:"'SF Mono', monospace",fontSize:11,color:"var(--text-label)"},R={width:"100%",padding:"8px 12px",background:"var(--accent-bg)",border:"1px solid var(--accent)",borderRadius:6,color:"var(--text-bright)",fontSize:12,cursor:"pointer"},P={display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:12,color:"var(--text-label)",borderBottom:"1px solid var(--border-subtle)"};export{_ as AnalysisPanel,_ as default};
