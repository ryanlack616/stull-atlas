import{r as I,M as j,E as A,F as K}from"./index-Djbrw6no.js";const Q=Object.keys(j);function V(a,s){const e=Q,i=[],r=[];for(const o of a){const t=s.resolve(o),n=t?s.getAnalysis(t.id):null;r.push((t==null?void 0:t.primaryName)??o);const f=[];for(const d of e){const x=(n==null?void 0:n[d])??0,c=j[d];f.push(c?x/100/c:0)}i.push(f)}return{matrix:i,oxides:e,names:r}}function D(a,s,e){const i=new Array(e.length).fill(0);for(let t=0;t<a.length;t++)for(let n=0;n<e.length;n++)i[n]+=a[t]*s[t][n];let r=0;for(let t=0;t<e.length;t++)K.includes(e[t])&&(r+=i[t]);r<A&&(r=A);const o={};for(let t=0;t<e.length;t++){const n=i[t]/r;n>A&&(o[e[t]]=I(n,4))}return o}function G(a,s){let e=0;for(const i of s){const r=a[i.oxide]??0,o=i.weight??1;if(i.target!==void 0)e+=o*(r-i.target)**2;else{const t=i.min??-1/0,n=i.max??1/0;r<t?e+=o*(r-t)**2:r>n&&(e+=o*(r-n)**2)}}return e}function F(a,s){const e=a.map((t,n)=>s&&n in s?s[n]:Math.max(t,0));let i=0,r=0;for(let t=0;t<e.length;t++)s&&t in s?i+=e[t]:r+=e[t];const o=Math.max(1-i,0);if(r<A){const t=e.filter((n,f)=>!(s&&f in s)).length;for(let n=0;n<e.length;n++)s&&n in s||(e[n]=o/t)}else{const t=o/r;for(let n=0;n<e.length;n++)s&&n in s||(e[n]*=t)}return e}function at(a,s){const{materialIds:e,targets:i,maxIterations:r=2e3,tolerance:o=.02,locks:t}=a,n=e.length;if(n===0)return Y("No materials selected");const{matrix:f,oxides:d,names:x}=V(e,s);let c=F(new Array(n).fill(1/n),t),N=[...c],h=1/0,M=.15,S=r;for(let u=0;u<r;u++){const b=D(c,f,d),w=G(b,i);if(w<h&&(h=w,N=[...c]),w<o*o){S=u+1;break}const $=new Array(n).fill(0),C=5e-4;for(let l=0;l<n;l++){if(t&&l in t)continue;const m=[...c],v=[...c];m[l]+=C,v[l]-=C;const U=G(D(F(m,t),f,d),i),W=G(D(F(v,t),f,d),i);$[l]=(U-W)/(2*C)}for(let l=0;l<n;l++)t&&l in t||(c[l]-=M*$[l]);c=F(c,t),u%200===199&&(M*=.7)}c=F(N,t);const y=D(c,f,d),g=G(y,i),R=g<o*o,_=i.map(u=>{const b=y[u.oxide]??0;let w=!1,$=0;if(u.target!==void 0)$=b-u.target,w=Math.abs($)<o;else{const C=u.min??-1/0,l=u.max??1/0;b<C?($=b-C,w=!1):b>l?($=b-l,w=!1):($=0,w=!0)}return{oxide:u.oxide,target:u.target??null,min:u.min??null,max:u.max??null,actual:I(b,3),satisfied:w,delta:I($,3)}}),E=_.filter(u=>u.satisfied).length,z=R?`Converged: all ${i.length} targets met within tolerance ${o}`:`${E}/${i.length} targets met (residual ${I(g,4)})`;return{weights:c.map(u=>I(u*100,1)),materialIds:e,materialNames:x,umf:y,targetResults:_,residual:I(g,6),converged:R,iterations:S,summary:z}}function Y(a){return{weights:[],materialIds:[],materialNames:[],umf:{},targetResults:[],residual:1/0,converged:!1,iterations:0,summary:a}}const Z=Object.keys(j);function k(a,s){const e=Z,i=[],r=[];for(const o of a){const t=s.resolve(o),n=t?s.getAnalysis(t.id):null;r.push((t==null?void 0:t.primaryName)??o);const f=[];for(const d of e){const x=(n==null?void 0:n[d])??0,c=j[d];f.push(c?x/100/c:0)}i.push(f)}return{matrix:i,oxides:e,names:r}}function T(a,s,e){const i=new Array(e.length).fill(0);for(let t=0;t<a.length;t++)for(let n=0;n<e.length;n++)i[n]+=a[t]*s[t][n];let r=0;for(let t=0;t<e.length;t++)K.includes(e[t])&&(r+=i[t]);r<A&&(r=A);const o={};for(let t=0;t<e.length;t++){const n=i[t]/r;n>A&&(o[e[t]]=I(n,4))}return o}function X(a,s){let e=0;for(const i of s){const r=a[i.oxide]??0,o=i.weight??1;if(i.target!==void 0)e+=o*(r-i.target)**2;else{const t=i.min??-1/0,n=i.max??1/0;r<t?e+=o*(r-t)**2:r>n&&(e+=o*(r-n)**2)}}return e}function tt(a,s){const e=new Array(a).fill(0);let i=0;for(let t=0;t<a;t++)s&&t in s?(e[t]=s[t],i+=s[t]):e[t]=-Math.log(Math.random()+1e-10);let r=e.reduce((t,n,f)=>s&&f in s?t:t+n,0);const o=Math.max(1-i,0);r<A&&(r=A);for(let t=0;t<a;t++)s&&t in s||(e[t]=e[t]/r*o);return e}function et(a,s,e=.3,i){const r=new Array(a.length);for(let o=0;o<a.length;o++){if(i&&o in i){r[o]=i[o];continue}const t=Math.min(a[o],s[o]),f=Math.max(a[o],s[o])-t;r[o]=t-e*f+Math.random()*(1+2*e)*f,r[o]=Math.max(0,r[o])}return P(r,i)}function nt(a,s,e=.1,i){const r=[...a];for(let o=0;o<r.length;o++)i&&o in i||Math.random()<s&&(r[o]+=(Math.random()-.5)*2*e,r[o]=Math.max(0,r[o]));return P(r,i)}function P(a,s){const e=a.map((t,n)=>s&&n in s?s[n]:Math.max(t,0));let i=0,r=0;for(let t=0;t<e.length;t++)s&&t in s?i+=e[t]:r+=e[t];const o=Math.max(1-i,0);if(r<A){const t=e.filter((n,f)=>!(s&&f in s)).length;for(let n=0;n<e.length;n++)s&&n in s||(e[n]=o/t)}else{const t=o/r;for(let n=0;n<e.length;n++)s&&n in s||(e[n]*=t)}return e}function q(a,s,e){let i=Math.floor(Math.random()*a.length);for(let r=1;r<e;r++){const o=Math.floor(Math.random()*a.length);s[o]<s[i]&&(i=o)}return[...a[i]]}function it(a,s){let e=0;for(let i=0;i<a.length;i++)e+=(a[i]-s[i])**2;return Math.sqrt(e)}function lt(a,s){const{materialIds:e,targets:i,populationSize:r=80,generations:o=200,mutationRate:t=.15,crossoverRate:n=.7,tournamentSize:f=3,topK:d=5,tolerance:x=.02,locks:c,onProgress:N}=a,h=e.length;if(h===0)return{best:ot("No materials selected"),alternatives:[],history:[],totalGenerations:0};const{matrix:M,oxides:S,names:y}=k(e,s);let g=[];for(let l=0;l<r;l++)g.push(tt(h,c));const R=[];let _=g[0],E=1/0;const z=2;for(let l=0;l<o;l++){const m=g.map(p=>{const O=T(p,M,S);return X(O,i)});let v=0,U=0;for(let p=0;p<m.length;p++)U+=m[p],m[p]<m[v]&&(v=p);if(m[v]<E&&(E=m[v],_=[...g[v]]),R.push({generation:l,bestCost:m[v],avgCost:U/m.length}),N==null||N(l,m[v]),E<x*x)break;const B=[...m.map((p,O)=>O).sort((p,O)=>m[p]-m[O]).slice(0,z).map(p=>[...g[p]])];for(;B.length<r;){const p=q(g,m,f),O=q(g,m,f);let L;Math.random()<n?L=et(p,O,.3,c):L=[...p];const J=.15*(1-l/o*.5);L=nt(L,t,J,c),B.push(L)}g=B}const u=H(_,M,S,y,e,i,x),b=g.map(l=>({weights:l,cost:X(T(l,M,S),i)}));b.sort((l,m)=>l.cost-m.cost);const w=[],$=.05,C=[_];for(const l of b){if(w.length>=d-1)break;C.every(v=>it(l.weights,v)>$)&&l.cost<x*10&&(C.push(l.weights),w.push(H(l.weights,M,S,y,e,i,x)))}return{best:u,alternatives:w,history:R,totalGenerations:R.length}}function H(a,s,e,i,r,o,t){const n=T(a,s,e),f=X(n,o),d=f<t*t,x=o.map(h=>{const M=n[h.oxide]??0;let S=!1,y=0;if(h.target!==void 0)y=M-h.target,S=Math.abs(y)<t;else{const g=h.min??-1/0,R=h.max??1/0;M<g?y=M-g:M>R?y=M-R:(y=0,S=!0)}return{oxide:h.oxide,target:h.target??null,min:h.min??null,max:h.max??null,actual:I(M,3),satisfied:S,delta:I(y,3)}}),c=x.filter(h=>h.satisfied).length,N=d?`GA converged: all ${o.length} targets met`:`GA: ${c}/${o.length} targets met (residual ${I(f,4)})`;return{weights:a.map(h=>I(h*100,1)),materialIds:r,materialNames:i,umf:n,targetResults:x,residual:I(f,6),converged:d,iterations:0,summary:N}}function ot(a){return{weights:[],materialIds:[],materialNames:[],umf:{},targetResults:[],residual:1/0,converged:!1,iterations:0,summary:a}}export{at as a,lt as o};
